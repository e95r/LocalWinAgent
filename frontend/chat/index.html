<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>LocalWinAgent — чат</title>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f6f9;
            color: #222;
        }
        header {
            background: #005fb8;
            color: #fff;
            padding: 16px 24px;
        }
        header h1 {
            margin: 0;
            font-size: 20px;
        }
        main {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
            padding: 16px;
        }
        #messages {
            flex: 1;
            background: #fff;
            border-radius: 12px;
            padding: 16px;
            overflow-y: auto;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        .message {
            margin-bottom: 12px;
        }
        .message.user {
            text-align: right;
        }
        .message.agent {
            text-align: left;
        }
        .bubble {
            display: inline-block;
            padding: 10px 14px;
            border-radius: 14px;
            max-width: 70%;
            white-space: pre-wrap;
        }
        .user .bubble {
            background: #005fb8;
            color: #fff;
            border-bottom-right-radius: 0;
        }
        .agent .bubble {
            background: #e9ecf1;
            color: #222;
            border-bottom-left-radius: 0;
        }
        .items-title {
            font-weight: 600;
            margin: 12px 0 6px;
            color: #1a1a1a;
        }
        .items-list {
            list-style: decimal inside;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .items-list li {
            display: flex;
            align-items: center;
        }
        .item-button {
            border: 1px solid #c5ccd6;
            background: #fff;
            color: #0f1c2e;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            transition: background 0.2s ease, box-shadow 0.2s ease;
            font-size: 14px;
        }
        .item-button:hover {
            background: #eef3fb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .items-hint {
            margin-top: 8px;
            font-size: 12px;
            color: #4a5568;
        }
        form {
            margin-top: 16px;
            display: flex;
            gap: 12px;
        }
        textarea {
            flex: 1;
            resize: none;
            border: 1px solid #d0d7de;
            border-radius: 10px;
            padding: 12px;
            font-size: 15px;
            height: 80px;
        }
        button {
            background: #005fb8;
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 15px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        button:hover {
            background: #004a90;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            gap: 16px;
        }
        .controls label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        select {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid #d0d7de;
        }
        #status {
            font-size: 12px;
            color: #555;
        }
        #confirm-container {
            margin-top: 8px;
            display: none;
        }
        #confirm-container button {
            margin-right: 8px;
        }
    </style>
</head>
<body>
<header>
    <h1>LocalWinAgent — локальный ассистент</h1>
</header>
<main>
    <div class="controls">
        <label>
            <input type="checkbox" id="autoConfirm" />
            Автоподтверждение действий
        </label>
        <label>
            Модель:
            <select id="modelSelect">
                <option value="llama3.1:8b" selected>llama3.1:8b</option>
                <option value="qwen2:7b">qwen2:7b</option>
            </select>
        </label>
        <span id="status">Ожидание подключения…</span>
    </div>
    <div id="messages"></div>
    <div id="confirm-container">
        <button id="confirm-button">Подтвердить</button>
        <button id="reject-button">Отменить</button>
    </div>
    <form id="chat-form">
        <textarea id="message" placeholder="Введите команду или вопрос"></textarea>
        <button type="submit">Отправить</button>
    </form>
</main>
<script>
    const wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
    const socket = new WebSocket(wsUrl);
    const messagesEl = document.getElementById('messages');
    const formEl = document.getElementById('chat-form');
    const messageInput = document.getElementById('message');
    const autoConfirmEl = document.getElementById('autoConfirm');
    const statusEl = document.getElementById('status');
    const confirmContainer = document.getElementById('confirm-container');
    const confirmButton = document.getElementById('confirm-button');
    const rejectButton = document.getElementById('reject-button');
    const modelSelect = document.getElementById('modelSelect');

    let requiresConfirmation = false;

    socket.addEventListener('open', () => {
        statusEl.textContent = 'Подключено';
    });

    socket.addEventListener('close', () => {
        statusEl.textContent = 'Соединение закрыто';
    });

    socket.addEventListener('error', () => {
        statusEl.textContent = 'Ошибка WebSocket';
    });

    socket.addEventListener('message', (event) => {
        const data = JSON.parse(event.data);
        addMessage('agent', data.response, data);
        requiresConfirmation = data.requires_confirmation;
        confirmContainer.style.display = requiresConfirmation ? 'flex' : 'none';
    });

    function addMessage(role, text, meta = {}) {
        const wrapper = document.createElement('div');
        wrapper.className = `message ${role}`;
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        if (role === 'agent' && meta.intent === 'list_apps' && Array.isArray(meta.items) && meta.items.length) {
            const [firstLine] = text.split('\n');
            bubble.textContent = firstLine || text;
            renderAppList(bubble, meta.items);
        } else {
            bubble.textContent = text;
        }
        wrapper.appendChild(bubble);
        messagesEl.appendChild(wrapper);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function renderAppList(container, items) {
        const title = document.createElement('div');
        title.className = 'items-title';
        title.textContent = 'Найденные программы:';
        container.appendChild(title);

        const list = document.createElement('ol');
        list.className = 'items-list';

        items.forEach((item, index) => {
            if (!item) {
                return;
            }
            const listItem = document.createElement('li');
            listItem.setAttribute('data-index', String(index + 1));

            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'item-button';
            button.textContent = item;
            button.addEventListener('click', () => {
                messageInput.value = `открой ${item}`;
                messageInput.focus();
            });

            listItem.appendChild(button);
            list.appendChild(listItem);
        });

        container.appendChild(list);

        const hint = document.createElement('div');
        hint.className = 'items-hint';
        hint.textContent = 'Нажмите на программу, чтобы быстро подготовить команду на её запуск.';
        container.appendChild(hint);
    }

    formEl.addEventListener('submit', (event) => {
        event.preventDefault();
        const text = messageInput.value.trim();
        if (!text) {
            return;
        }
        addMessage('user', text);
        socket.send(JSON.stringify({
            message: text,
            auto_confirm: autoConfirmEl.checked,
            confirm: false,
            model: modelSelect.value
        }));
        messageInput.value = '';
    });

    confirmButton.addEventListener('click', () => {
        if (!requiresConfirmation) {
            return;
        }
        socket.send(JSON.stringify({
            message: 'да',
            auto_confirm: autoConfirmEl.checked,
            confirm: true,
            model: modelSelect.value
        }));
        confirmContainer.style.display = 'none';
        requiresConfirmation = false;
    });

    rejectButton.addEventListener('click', () => {
        if (!requiresConfirmation) {
            return;
        }
        addMessage('user', 'нет');
        socket.send(JSON.stringify({
            message: 'нет',
            auto_confirm: autoConfirmEl.checked,
            confirm: false,
            model: modelSelect.value
        }));
        confirmContainer.style.display = 'none';
        requiresConfirmation = false;
    });
</script>
</body>
</html>
